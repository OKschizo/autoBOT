<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Finance Bot Manager</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Markdown parser and HTML sanitizer for chat formatting -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#BFFF00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 17L12 22L22 17" stroke="#BFFF00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 12L12 17L22 12" stroke="#BFFF00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>AUTO BOT MANAGER</span>
                </div>
            </div>
            <div class="nav-center">
                <button class="nav-tab active" data-tab="bots">Bots</button>
                <button class="nav-tab" data-tab="chat">Q&A Chat</button>
                <button class="nav-tab" data-tab="data">Data Status</button>
            </div>
            <div class="nav-right">
                <div id="user-info" class="user-info" style="display: none;">
                    <img id="user-avatar" class="user-avatar" alt="User">
                    <span id="user-name"></span>
                    <button onclick="signOut()" class="btn-secondary" style="margin-left: 12px; padding: 8px 16px;">Sign Out</button>
                </div>
                <div id="google-signin-container"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Bots Management Tab -->
        <div id="bots-tab" class="tab-content active">
            <div class="content-header">
                <h1>Bot Management</h1>
                <p class="subtitle">Deploy and manage your Telegram and Discord bots</p>
            </div>

            <!-- Add Bot Section -->
            <div class="card add-bot-card">
                <div style="margin-bottom: 16px;">
                    <h2 style="margin-bottom: 8px;">Deploy Your Bot</h2>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Add your Telegram or Discord bot to run 24/7 in the cloud. 
                        Your bot will use the shared knowledge base that updates every 10 minutes.
                    </p>
                </div>
                <form id="add-bot-form" class="bot-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bot Name <span style="color: var(--status-error);">*</span></label>
                            <input type="text" id="bot-name" placeholder="e.g., Support Bot" required>
                            <span style="font-size: 12px; color: var(--text-muted);">Give your bot a friendly name</span>
                        </div>
                        <div class="form-group">
                            <label>Platform <span style="color: var(--status-error);">*</span></label>
                            <select id="bot-platform" required>
                                <option value="">Select Platform</option>
                                <option value="telegram">üì± Telegram</option>
                                <option value="discord">üí¨ Discord</option>
                            </select>
                            <span style="font-size: 12px; color: var(--text-muted);">Where your bot will run</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bot Token <span style="color: var(--status-error);">*</span></label>
                            <input type="password" id="bot-token" placeholder="Paste your bot token here" required>
                            <span style="font-size: 12px; color: var(--text-muted);">
                                Get from <a href="https://t.me/BotFather" target="_blank" style="color: var(--accent-primary);">@BotFather</a> (Telegram) 
                                or <a href="https://discord.com/developers/applications" target="_blank" style="color: var(--accent-primary);">Discord Dev Portal</a>
                            </span>
                        </div>
                        <div class="form-group">
                            <label>AI Model</label>
                            <select id="bot-model">
                                <option value="gpt-4o">GPT-4o (Recommended)</option>
                                <option value="gpt-4o-mini">GPT-4o Mini (Faster)</option>
                                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            </select>
                            <span style="font-size: 12px; color: var(--text-muted);">AI model for responses</span>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Deploy Bot</span>
                    </button>
                </form>
            </div>

            <!-- Bots List -->
            <div class="bots-grid" id="bots-list">
                <!-- Bot cards will be inserted here -->
            </div>
        </div>

        <!-- Q&A Chat Tab -->
        <div id="chat-tab" class="tab-content">
            <div class="chat-layout">
                <!-- Sidebar for Conversation Threads -->
                <aside class="chat-sidebar" id="chat-sidebar">
                    <div class="sidebar-header">
                        <button class="btn-primary" id="new-thread-btn" onclick="createNewThread()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>New Conversation</span>
                        </button>
                    </div>
                    <div class="sidebar-content" id="threads-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No conversations yet</p>
                    </div>
                </aside>

                <!-- Main Chat Area -->
                <div class="chat-main">
                    <!-- Prompt Editor Panel -->
                    <div class="prompt-editor-panel" id="prompt-editor-panel">
                        <div class="prompt-editor-header" onclick="togglePromptEditor()">
                            <div class="prompt-editor-title">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right: 8px;">
                                    <path d="M8 2L2 6L8 10L14 6L8 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M2 10L8 14L14 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>System Prompt</span>
                                <span class="prompt-status" id="prompt-status">Default</span>
                            </div>
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" class="prompt-toggle-icon" id="prompt-toggle-icon">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="prompt-editor-content" id="prompt-editor-content" style="display: none;">
                            <div class="prompt-template-selector">
                                <label>Template:</label>
                                <select id="prompt-template-select" onchange="loadPromptTemplate()">
                                    <option value="">Custom</option>
                                    <option value="default">Default</option>
                                    <option value="technical">Technical</option>
                                    <option value="beginner_friendly">Beginner Friendly</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="seo_specialist">SEO Specialist</option>
                                </select>
                            </div>
                            <textarea id="prompt-textarea" placeholder="Enter custom system prompt or select a template above..."></textarea>
                            <div class="prompt-editor-actions">
                                <button class="btn-secondary" onclick="resetPrompt()">Reset</button>
                                <button class="btn-primary" onclick="savePrompt()">Use This Prompt</button>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="welcome-message">
                                <div class="welcome-icon">üí¨</div>
                                <h2>Welcome to Auto Finance Bot</h2>
                                <p>Ask me anything about Auto Finance, Autopools, or DeFi strategies!</p>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chat-input" placeholder="Ask a question..." disabled>
                            <button id="send-button" class="btn-primary" disabled>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Status Tab -->
        <div id="data-tab" class="tab-content">
            <div class="content-header">
                <h1>Data Status</h1>
                <p class="subtitle">Knowledge base scraping and updates</p>
            </div>

            <!-- Scraper Status Card -->
            <div class="card" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Auto-Scraper Status</h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="manual-scrape-btn" class="btn-primary" onclick="triggerManualScrape('full')" title="Scrape all sources (GitBook + Website + Blog)">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right: 8px;">
                                <path d="M13 2L3 12M13 2V7M13 2H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Full Scrape
                        </button>
                        <button id="gitbook-scrape-btn" class="btn-secondary" onclick="triggerManualScrape('gitbook')" title="Scrape only GitBook documentation">
                            üìö GitBook
                        </button>
                        <button id="website-scrape-btn" class="btn-secondary" onclick="triggerManualScrape('website')" title="Scrape only website (live data)">
                            üåê Website
                        </button>
                        <button id="blog-scrape-btn" class="btn-secondary" onclick="triggerManualScrape('blog')" title="Scrape only blog">
                            üìù Blog
                        </button>
                    </div>
                </div>
                
                <div class="data-status-grid">
                    <div class="data-stat-item">
                        <span class="data-stat-label">Status:</span>
                        <span id="scraper-status" class="status-badge running">Running</span>
                    </div>
                    <div class="data-stat-item">
                        <span class="data-stat-label">Last Scrape:</span>
                        <span id="last-scrape-time">Never</span>
                    </div>
                    <div class="data-stat-item">
                        <span class="data-stat-label">Next Scrape:</span>
                        <span id="next-scrape-time">Calculating...</span>
                    </div>
                    <div class="data-stat-item">
                        <span class="data-stat-label">Total Scrapes:</span>
                        <span id="scrape-count">0</span>
                    </div>
                </div>
            </div>

            <!-- Data Chunks Card -->
            <div class="card" style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 16px;">Knowledge Base</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-value" id="gitbook-chunks">0</div>
                        <div class="stat-label">GitBook</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üåê</div>
                        <div class="stat-value" id="website-chunks">0</div>
                        <div class="stat-label">Website</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-value" id="blog-chunks">0</div>
                        <div class="stat-label">Blog</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="total-chunks">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>

            <!-- Scrape Progress Card (shown when scraping) -->
            <div id="scrape-progress-container" class="card" style="margin-bottom: 24px; display: none;">
                <h2 style="margin-bottom: 16px;">üìä Current Scrape Progress</h2>
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Stage:</div>
                    <div id="scrape-stage" style="font-size: 16px; font-weight: 600; color: var(--accent-primary); margin-bottom: 12px;">-</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Status:</div>
                    <div id="scrape-current-step" style="font-size: 14px; color: var(--text-primary);">Waiting...</div>
                </div>
                
                <!-- GitBook Progress -->
                <div id="gitbook-progress" style="margin-bottom: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">GitBook Pages</span>
                        <span class="progress-text" style="font-size: 14px; color: var(--text-secondary);">0/0</span>
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div class="progress-bar-fill" style="height: 100%; background: var(--accent-primary); transition: width 0.3s; width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Website Progress -->
                <div id="website-progress" style="margin-bottom: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">Website Pages</span>
                        <span class="progress-text" style="font-size: 14px; color: var(--text-secondary);">0/0</span>
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div class="progress-bar-fill" style="height: 100%; background: var(--accent-primary); transition: width 0.3s; width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Blog Progress -->
                <div id="blog-progress" style="margin-bottom: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">Blog Posts</span>
                        <span class="progress-text" style="font-size: 14px; color: var(--text-secondary);">0/0</span>
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div class="progress-bar-fill" style="height: 100%; background: var(--accent-primary); transition: width 0.3s; width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Index Progress -->
                <div id="index-progress" style="margin-bottom: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">Index Chunks</span>
                        <span class="progress-text" style="font-size: 14px; color: var(--text-secondary);">0/0</span>
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div class="progress-bar-fill" style="height: 100%; background: var(--accent-primary); transition: width 0.3s; width: 0%;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                    üí° <strong>Tip:</strong> View detailed logs in <a href="https://console.cloud.google.com/logs/query" target="_blank" style="color: var(--accent-primary);">Google Cloud Console</a>
                </div>
            </div>

            <!-- Scrape History Card -->
            <div class="card">
                <h2 style="margin-bottom: 16px;">Recent Scrapes</h2>
                <div id="scrape-history" class="scrape-history">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No scrape history yet</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Thread Title Edit Modal -->
    <div id="thread-title-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Edit Conversation Title</h2>
                <button class="modal-close" onclick="closeThreadTitleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="thread-title-input" placeholder="Enter conversation title..." style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeThreadTitleModal()">Cancel</button>
                <button class="btn-primary" onclick="saveThreadTitle()">Save</button>
            </div>
        </div>
    </div>

    <!-- Bot Details Modal -->
    <div id="bot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-bot-name">Bot Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="bot-status-section">
                    <div class="status-badge" id="modal-status">Stopped</div>
                    <div class="bot-info">
                        <p><strong>Platform:</strong> <span id="modal-platform"></span></p>
                        <p><strong>Model:</strong> <span id="modal-model"></span></p>
                        <p><strong>Uptime:</strong> <span id="modal-uptime">N/A</span></p>
                    </div>
                </div>
                <div class="logs-section">
                    <h3>Activity Logs</h3>
                    <div class="logs-container" id="modal-logs">
                        <p class="no-logs">No logs available</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-delete-btn" class="btn-danger">Delete Bot</button>
                <button id="modal-close-btn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
</body>
</html>
