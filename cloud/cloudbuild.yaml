steps:
  # Pull previous image for caching (optional, speeds up builds)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull gcr.io/$PROJECT_ID/autofinance-bot:latest || exit 0']
  
  # Build Docker image with layer caching (Cloud Build's native caching)
  # Layer caching speeds up rebuilds when dependencies don't change
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', 'gcr.io/$PROJECT_ID/autofinance-bot:latest',
      '--cache-from', 'gcr.io/$PROJECT_ID/autofinance-bot:latest',
      '--progress=plain',
      '.'
    ]
  
  # Push to registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/autofinance-bot:latest']
  
  # Deploy to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'run', 'deploy', 'autofinance-bot',
      '--image', 'gcr.io/$PROJECT_ID/autofinance-bot:latest',
      '--region', 'us-central1',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--memory', '4Gi',
      '--cpu', '2',
      '--timeout', '300',
      '--max-instances', '10',
      '--set-env-vars',
      'GOOGLE_CLIENT_ID=${_GOOGLE_CLIENT_ID},ANTHROPIC_API_KEY=${_ANTHROPIC_API_KEY},OPENAI_API_KEY=${_OPENAI_API_KEY},BOT_MODEL=${_BOT_MODEL},TOKENIZERS_PARALLELISM=false,PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright,PLAYWRIGHT_REMOTE_BROWSER_ENDPOINT=${_PLAYWRIGHT_REMOTE_BROWSER_ENDPOINT}'
    ]

images:
  - 'gcr.io/$PROJECT_ID/autofinance-bot:latest'

options:
  machineType: 'E2_HIGHCPU_8'  # 8x faster builds (~$0.16 per build vs free)
  logging: CLOUD_LOGGING_ONLY
